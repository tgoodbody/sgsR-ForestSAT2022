"0","  shapes_dir <- ""F:/_2021_SSCALS/modelling/_modeldevel/data/AOI"""
"0","  dsmart_dir <- ""F:/_2021_SSCALS/modelling/_modeldevel/DSMART"""
"0","  "
"0","  # Load covariates"
"0","  files <- list.files(""F:/_2021_SSCALS/modelling/_modeldevel/data/covariates/_dsmart"", full.names = TRUE)"
"0","  covariates <- terra::rast(files)"
"0","  "
"0","  "
"0","  # Load the polygons and associated observations"
"0","  polygons <- terra::vect(""F:/_2021_SSCALS/modelling/_modeldevel/DSMART/dsmart_site_ser_polys.gpkg"")"
"0","  "
"0","  if(include_bgc) {"
"0","    bgc <- st_read(file.path(shapes_dir, ""bec.gpkg""), quiet = TRUE) %>% "
"0","      mutate(MAP_LABEL = as.factor(MAP_LABEL), "
"0","             bgc = as.numeric(as.factor(MAP_LABEL))) "
"0","    tem_geom <- st_geometry(bgc)"
"0","    "
"0","    # Fix geometries that aren't polygon/multipolygon"
"0","    for(i in 1:length(tem_geom)) {"
"0","      if(!st_geometry_type(tem_geom[[i]]) %in% c(""POLYGON"", ""MULTIPOLYGON"")) "
"0","        tem_geom[[i]] <- st_collection_extract(tem_geom[[i]], ""POLYGON"") %>% "
"0","          st_multipolygon()"
"0","    }"
"0","    st_geometry(bgc) <- st_cast(tem_geom, ""MULTIPOLYGON"")"
"0","    "
"0","    level_table <- unique.data.frame(data.frame("
"0","      label = as.character(bgc$MAP_LABEL), "
"0","      value = as.numeric(bgc$MAP_LABEL)))"
"0","    "
"0","    bgc_rast <- as.factor(terra::rasterize(vect(bgc), covariates[[1]], field = ""bgc""))"
"0","    levels(bgc_rast) <- level_table"
"0","    "
"0","    # File needs to be written to disk and then reloaded back into R for proper "
"0","    # feature assignments"
"0","    bgc_rast <- writeRaster(bgc_rast, file.path(dsmart_dir, ""inputs"", ""bgc.tif""), "
"0","                            overwrite = TRUE, wopt = list(datatype = ""INT2S""))"
"0","    covariates <- c(covariates, bgc_rast)"
"0","    factors <- ""bgc"""
"0","    "
"0","  } else {"
"0","    factors <- NULL"
"0","  }"
"0","  "
"0","  # Load TEM composition and additional observations"
"0","  composition <- read.csv(""F:/_2021_SSCALS/modelling/_modeldevel/DSMART/dsmart_site_ser_composition.csv"") %>% "
"0","    dplyr::select(-Subzone)"
"0","  observations <- read.csv(""F:/_2021_SSCALS/modelling/_modeldevel/DSMART/dsmart_site_ser_observations.csv"") %>% "
"0","    dplyr::select(any_of(c(""X"", ""Y"", ""MapUnit"", ""StructuralStage"")))"
"0","  "
"0","  dsm_data <- list("
"0","    dsmart_dir = dsmart_dir,"
"0","    covariates = covariates,"
"0","    polygons = polygons,"
"0","    composition = composition,"
"0","    observations = observations, "
"0","    factors = factors)"
"0",""
"0",""
