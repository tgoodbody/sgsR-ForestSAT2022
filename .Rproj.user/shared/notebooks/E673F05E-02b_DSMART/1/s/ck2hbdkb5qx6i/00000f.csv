"0",""
"0","if(run == ""site_ser"") {"
"0","    covariates <- dsm_data[[""covariates""]]"
"0","    composition <- dsm_data[[""composition""]]"
"0",""
"0","    if(dir.exists(file.path(dsmart_dir, ""simple"")))"
"0","      unlink(file.path(dsmart_dir, ""simple""), recursive = TRUE)"
"0","    dir.create(file.path(dsmart_dir, ""simple""), showWarnings = FALSE)"
"0","    "
"0","    # Rasterize first calls only"
"0","    cov_sub <- subset(covariates, ""dtm20_1"")"
"0","    tem <- terra::vect(file.path(dsmart_dir, paste0(""dsmart_"", run, ""_polys.gpkg"")))"
"0","    tem$MapUnit1_num <- as.numeric(as.factor(tem$MapUnit1))"
"0","    tem_rast <- terra::rasterize(tem, cov_sub, field = ""MapUnit1_num"", "
"0","                                 filename = file.path(dsmart_dir, ""simple"", ""site_series_simple.tif""), "
"0","                                 overwrite = TRUE)"
"0","    "
"0","    tem_rast_index <- data.frame(name = tem$MapUnit1, code = tem$MapUnit1_num) %>% "
"0","      unique() %>% "
"0","      arrange(code)"
"0","    "
"0","    write.table(tem_rast_index, file.path(dsmart_dir, ""simple"", ""site_ser_simple_lookup.txt""),"
"0","                row.names = FALSE, quote = FALSE, sep = "","")"
"0","    "
"0","    # Generate probabilities based on composition"
"0","    ss_calls <- unique(composition$MapUnit)"
"0","    composition_remake <- dplyr::bind_rows(lapply(unique(composition$POLY_NO), function(i) {"
"0","      composition %>% dplyr::filter(POLY_NO == i) %>% "
"0","        dplyr::select(POLY_NO, MapUnit, proportion) %>% "
"0","        rbind(data.frame("
"0","          POLY_NO = .$POLY_NO[1], "
"0","          MapUnit = ss_calls[!ss_calls %in% .$MapUnit],"
"0","          proportion = 0"
"0","        ))"
"0","    }))"
"0","    "
"0","    tem_remake <- values(tem) %>% "
"0","      dplyr::select(POLY_NO) %>% "
"0","      merge(composition_remake) %>% "
"0","      mutate(proportion = proportion / 100) %>% "
"0","      merge(tem, .)"
"0","    "
"0","    tem_props <- rast(lapply(unique(tem_remake$MapUnit), function(i) {"
"0","      tem_remake[tem_remake$MapUnit == i] %>% "
"0","        stats::setNames(c(names(.)[names(.) != ""proportion""], paste0(""probability_"", i))) %>% "
"0","        rasterize(cov_sub, field = paste0(""probability_"", i), overwrite = TRUE, "
"0","                  filename = file.path(dsmart_dir, ""simple"", paste0(""probability_"", i, "".tif"")))"
"0","    }))"
"0","    tem_rast <- list(class = tem_rast, props = tem_props, class_index = tem_rast_index)"
"0","}"
"0",""
