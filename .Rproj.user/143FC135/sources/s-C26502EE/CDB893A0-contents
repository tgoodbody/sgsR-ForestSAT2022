---
title: "`sgsR`: Structurally Guided Sampling"
author: "_Tristan Goodbody, Nicholas Coops, Martin Queinnec, Joanne White, Piotr Tompalski, Andrew Hudak, David Auty, Ruben Valbuena, Antoine LeBoeuf, Ian Sinclair, Grant McCartney, Jean-Francois Prieur, Murray Woods_"
institute: "__University of British Columbia__"
format:
  revealjs: 
    theme: sky
    self-contained: true
    slide-number: true
    preview-links: auto
    logo: images/logo.png
    footer: <https://tgoodbody.github.io/sgsR/>
    progress: true
---

```{r include=FALSE}
library(sgsR)
library(terra)
library(sf)

r <- system.file("extdata", "mraster.tif", package = "sgsR")
mr <- terra::rast(r)

#--- Load access network from sgsR internal data ---#
a <- system.file("extdata", "access.shp", package = "sgsR")
#--- load the access vector using the sf package ---#
access <- sf::st_read(a)
```

## Overview

::: incremental
-   Brief inventory and sampling overview

-   Discuss using auxiliary variables within sampling frameworks

-   Structurally guided sampling using Airborne Laser Scanning

-   `sgsR` overview

-   Programmatic examples of the package
:::

## Forest inventories {.smaller}

::: {.fragment .fade-up}
**Purpose:** Obtain knowledge about the population (forest area) under investigation and provide estimates of specific target variables.
:::

::: {.fragment .fade-up}
**Needed information:** Defined by the scope & scale of the inventory. Answered by questions like:
:::

::: incremental
-   Who/what is the information for? (e.g. Reporting obligations, timber production)

-   How big of an area are we inventorying? (e.g. National level, operational level)
:::

::: {.fragment .fade-up}
Answers dictate the sampling approaches to fulfill inventory obligations and objectives.
:::

## Sampling {.smaller}

::: {.fragment .fade-up}
-   ***Mensuration is a cornerstone of forest management.***
:::

::: {.fragment .fade-up}
-   Sampling drives accurate forest attribute estimates (e.g. forest area, stem volume).
:::

::: {.fragment .fade-up}
Sampling can be:
:::

::: incremental
-   Labour intensive

-   Logistically challenging

-   **Expensive**
:::

::: {.fragment .fade-up}
-   We want to balance these challenges with attribute estimate accuracy
:::

::: {.fragment .fade-up}
-   Many sampling methods, but traditional and commonly used examples include:
:::

## Probability-based sampling {.smaller}

Common sampling methods include randomized sampling where probabilities for each sample unit are known and equivalent.

::: {.fragment .fade-up}
```{r}
#| warning: false
#| echo: true
#| results: hide
#| fig-align: center
#--- simple random sampling ---#
sample_srs(raster = mr, nSamp = 100, plot = TRUE)

```
:::

## Systematic sampling {.smaller}

::: {.fragment .fade-up}
Systematic sampling methods are also common, where sample units are selected based on a defined distance.
:::

::: {.fragment .fade-up}
```{r}
#| warning: false
#| echo: true
#| results: hide
#| fig-align: center
#--- systematic sampling ---#
sample_systematic(raster = mr, cellsize = 1000, plot = TRUE)

```
:::

##  {auto-animate="true"}

Different tessellation shapes are fairly common

```{r}
#| warning: false
#| echo: true
#| results: hide
#| fig-align: center
#--- systematic sampling in hexagons ---#
sample_systematic(raster = mr, cellsize = 1000, square = FALSE, plot = TRUE)

```

##  {auto-animate="true"}

And combinations of systematic and simple random sampling also exists

```{r}
#| warning: false
#| echo: true
#| results: hide
#| fig-align: center
#--- systematic random sampling ---#
sample_systematic(raster = mr, cellsize = 1000, 
                  square = FALSE, location = "random", plot = TRUE)

```

## Auxiliary data {.smaller}

Probability-based sampling does not leverage auxiliary data such as:

![](images/auxiliary.png){fig-align="center" width="717"}

::: {.fragment .fade-up}
- Imagery, Feature-based inventories, ALS metrics (height, cover, variability)
:::

::: {.fragment .fade-up}
- Auxiliary data as *a-priori* information to guide *model-based* sampling has been fruitful.
:::

<center>

::: {.fragment .fade-up}
*The ALS data also provides an excellent source of prior information that may be used in the design phase of the field survey to reduce the size of the field data set.* [Gobakken et al. (2013)](http://dx.doi.org/10.14214/sf.943)
:::

</center>

## Stratification {.smaller}

Stratification using auxiliary data can lead to representative sampling approaches.

::: {layout-ncol="2"}

![Hawbaker et al. (2009)](images/sgs.png)

![Gobakken et al. (2013)](images/sgs2.png)

:::

##  {auto-animate="true"}

``` r
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           nStrata = 5) # 5 strata in p90
```

##  {auto-animate="true"}

``` {.r code-line-numbers="2"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           nStrata = 5) # 5 strata in p90
```

##  {auto-animate="true"}

``` {.r code-line-numbers="2-3"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           nStrata = 5) # 5 strata in p90
```

::: {.fragment .fade-up}
![](images/strat_1.png){fig-align="center"}
:::

##  {auto-animate="true"}

``` r
#--- perform dual metric stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           mraster2 = mr$zsd, # standard deviation of height
                           nStrata = 10, # 10 strata in p90
                           nStrata2 = 3) # 3 strata in zsd
```

##  {auto-animate="true"}

``` {.r code-line-numbers="2,4"}
#--- perform dual metric stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           mraster2 = mr$zsd, # standard deviation of height
                           nStrata = 10, # 10 strata in p90
                           nStrata2 = 3) # 3 strata in zsd
```

##  {auto-animate="true"}

``` {.r code-line-numbers="3,5"}
#--- perform dual metric stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           mraster2 = mr$zsd, # standard deviation of height
                           nStrata = 10, # 10 strata in p90
                           nStrata2 = 3) # 3 strata in zsd
```

::: {.fragment .fade-up}
![](images/strat_2.png){fig-align="center"}
:::

## Structurally guided sampling {auto-animate="true"}

```{r}
#| echo: true
#| eval: true
#| results: false
#| fig-align: center

#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # p90
                           mraster2 = mr$zsd, # standard deviation of height
                           nStrata = 10, # 10 strata in p90
                           nStrata2 = 3) # 3 strata in zsd

#--- structurally guided stratified sampling ---#
sample_strat(sraster = sraster, nSamp = 100, plot = TRUE)
```

## `sgsR`

![](images/logo.png){fig-align="center"}

## `sgsR` purpose {.smaller}

A growing number of studies have demonstrated that *a-priori* use of ALS metrics to guide sampling design provides methods that are:

::: incremental
-   transparent

-   repeatable

-   tuneable

-   spatially-explicit
:::

::: {.fragment .fade-up}
`sgsR` is intended to provide a simple to use toolbox for practitioners to leverage these benefits to provide primarily *model-based* sampling approaches for forest inventories.
:::

## overview

![](images/flow.png){fig-align="center"}

## Algorithm structure {.smaller}

::: incremental
-   `sgsR` was built using the `terra`, `sf`, & `tidyverse` packages

-   There are 4 primary function verbs that `sgsR` uses:

    -   `strat_*` - apply stratification to metrics raster (mraster) and output a stratified raster (sraster)

    -   `sample_*` - allocate samples using srasters produced from strat\_\* functions.

    -   `calculate_*`- calculate sample information or create useful intermediary sampling products.

    -   `extract_*` - extract pixels values from rasters to samples
:::

::: {.fragment .fade-in}
![](images/flow-01.png){fig-align="center"}
:::

## Example 1 - Stratified sampling

Lets read in some ALS metrics

``` {.r code-line-numbers="1,3,5,6"}
#--- Stratification ---#
#--- Load ALS metrics from sgsR internal data ---#
r <- system.file("extdata", "mraster.tif", package = "sgsR")

#--- Read ALS metrics using the terra package ---#
mraster <- terra::rast(r)
```

## Example 1 - Stratified sampling

Lets read in some ALS metrics - `mraster`.

``` {.r code-line-numbers="6"}
#--- Stratification ---#
#--- Load ALS metrics from sgsR internal data ---#
r <- system.file("extdata", "mraster.tif", package = "sgsR")

#--- Read ALS metrics using the terra package ---#
mraster <- terra::rast(r)
```

```{r}
#| warning: false
#| echo: false
#| results: hide
#| fig-align: center
terra::plot(mr$zq90, main = "p90")
```

##  {auto-animate="true"}

Lets also read in a linear road `access` network.

``` {.r code-line-numbers="4-5"}
#--- Load access network from sgsR internal data ---#
a <- system.file("extdata", "access.shp", package = "sgsR")

#--- load the access vector using the sf package ---#
access <- sf::st_read(a)
```

```{r}
#| warning: false
#| echo: false
#| results: hide
#| fig-align: center
terra::plot(mr$zq90, main = "p90 with road access")
plot(access, add = TRUE, col = "black")
```

##  {auto-animate="true"}

Like before, lets stratify `p90` in to 4 strata based on quantiles.

``` r
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)
```

```{r}
#| warning: false
#| echo: false
#| results: hide
#| fig-align: center
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mr$zq90, # input ALS metric - p90
                           nStrata = 4, plot = TRUE) # desired number of strata (4)
```

##  {auto-animate="true"}

Now lets use the `sraster` output.

``` {.r code-line-numbers="6"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)

#--- perform sampling ---#
samples <- sample_strat(sraster = sraster, 
                        nSamp = 100, 
                        access = access, 
                        buff_inner = 50, 
                        buff_outer = 400)
```

##  {auto-animate="true"}

Request 100 proportionally allocated samples.

``` {.r code-line-numbers="6-7"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)

#--- perform sampling ---#
samples <- sample_strat(sraster = sraster, 
                        nSamp = 100, 
                        access = access, 
                        buff_inner = 50, 
                        buff_outer = 400)
```

##  {auto-animate="true"}

Bring in the `access` road.

``` {.r code-line-numbers="6-8"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)

#--- perform sampling ---#
samples <- sample_strat(sraster = sraster, 
                        nSamp = 100, 
                        access = access, 
                        buff_inner = 50, 
                        buff_outer = 400)
```

##  {auto-animate="true"}

Specify we dont want samples within 50 m of `access`.

``` {.r code-line-numbers="6-9"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)

#--- perform sampling ---#
samples <- sample_strat(sraster = sraster, 
                        nSamp = 100, 
                        access = access, 
                        buff_inner = 50, 
                        buff_outer = 400)
```

##  {auto-animate="true"}

Or further than 400 m from `access`.

``` {.r code-line-numbers="6-10"}
#--- perform stratification ---#
sraster <- strat_quantiles(mraster = mraster$zq90, # input ALS metric - p90
                           nStrata = 4) # desired number of strata (4)

#--- perform sampling ---#
samples <- sample_strat(sraster = sraster, 
                        nSamp = 100, 
                        access = access, 
                        buff_inner = 50, 
                        buff_outer = 400)
```

## Example 1 - Stratified Sampling

Mapped result **(A)** and plotted result **(B)**.

Note buffered `access` in **A**. Points are samples in both **A** & **B**.

![](images/example1.png){fig-align="center"}

## Comparing distributions {.smaller}

When constraining by `access` its important to make sure that you're still sampling the entire distribution of metrics.

-   We see that access constrained (green) and the full population (yellow) are very similar.

![](images/accesscompare.png){fig-align="center"}

## Existing samples

::: {.fragment .fade-in}
Practitioners may ask:
:::

<center>

::: {.fragment .fade-in}
*"I have an existing sample network, can I use those same sample locations?"*
:::

::: {.fragment .fade-in}
*"If I go and visit those same sample units, where should I locate new samples for structural representation?"*
:::

</center>

## Augmenting an `existing` sample {.smaller}

::: {.fragment .fade-in}
Lets create an `existing` sample of 50 plots using simple random sampling (`sample_srs`).
:::

::: {.fragment .fade-in}
-   We are assuming these have been measured or used previously and can be revisited.
:::

::: {.fragment .fade-in}
```{r}
#| warning: false
#| echo: true
#| results: hide
#| fig-align: center
set.seed(2022)
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)
```
:::

## Sampling and metric densities

![](images/density.png){fig-align="center"}

## Example 2 - `existing` {.smaller}

::: {.fragment .fade-in}
Augmenting an `existing` sample can be done using the *Adapted Hypercube Evaluation of a Legacy Sample (AHELS)* algorithm. Originally presented by [Malone, Minansy & Brungard (2019)](https://peerj.com/articles/6451/).
:::

::: {.fragment .fade-in}
`sample_ahels()` works by:
:::

::: incremental
-   Determining representation of `existing` sample.

-   Determining number of additional samples that can / need to be added.

-   Generate quantile and covariance matrix of ALS metrics.

-   Identify where new samples are needed to balance quantile density and sampling density.

-   Iteratively locate samples.
:::

##  {auto-animate="true"}

We have our `existing` sample

``` {.r code-line-numbers="1-2"}
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)
```

```{r}
#| warning: false
#| echo: false
#| results: hide
#| fig-align: center
set.seed(2022)
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)
```

##  {auto-animate="true"}

Now we can use the `sample_ahels()` algorithm with our `als` metrics.

``` {.r code-line-numbers="5-6"}
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)

#--- augment sample network using sample_ahels ---#
#--- perform ahels sampling ---#
sample_ahels(mraster = mr,
             existing = existing,
             nSamp = 50)
```

##  {auto-animate="true"}

Specify our `existing` sample.

``` {.r code-line-numbers="5-7"}
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)

#--- augment sample network using sample_ahels ---#
#--- perform ahels sampling ---#
sample_ahels(mraster = mr,
             existing = existing,
             nSamp = 50)
```

##  {auto-animate="true"}

And specify we want 50 new sample units (`nSamp`).

``` {.r code-line-numbers="5-8"}
#--- simple random sampling ---#
existing <- sample_srs(raster = mr, nSamp = 50, plot = TRUE)

#--- augment sample network using sample_ahels ---#
#--- perform ahels sampling ---#
sample_ahels(mraster = mr,
             existing = existing,
             nSamp = 50)
```

## `sample_ahels()` result

Mapped result **(A)** and plotted result **(B)**.

Note ratios (black/red) and additional added samples e.g *n = 2* for each stratum.

![](images/e2s.png){fig-align="center"}

## `sample_ahels()` result

`existing` only **(A)** and addition of new samples **(B)**.

We see that metric and sample density become quite even - structurally representative.

![](images/hist.png){fig-align="center"}

## Summary {.smaller}

::: {.fragment .fade-in}
-   Structurally guided sampling methods show promise for *model-based* sampling
:::

::: {.fragment .fade-in}
-   The `sgsR` package provides many methods to implement SGS approaches
:::

::: {.fragment .fade-in}
-   We presented a few examples of `sgsR` functionality
:::

::: {.fragment .fade-in}
-   If you want to know more feel free to come and talk to me, or use the link on the slide below for documentation and vignettes
:::

::: {.fragment .fade-in}
![](images/logo.png){fig-align="center" width="205"}
:::

## Thank you!

<center>

Special thanks to the Canadian Wood Fibre Centre for funding this research!

***My Twitter: [\@GoodbodyT](https://twitter.com/GoodbodyT)***

***IRSS Twitter: [\@IRSS_UBC](https://twitter.com/IRSS_UBC)***

</center>

***Collaborators***

::: columns
::: {.column width="40%"}
-   Martin Queinnec
-   Joanne White
-   Andrew Hudak
-   Ruben Valbuena
-   Murray Woods
-   David Auty
:::

::: {.column width="10%"}
:::

::: {.column width="40%"}
-   Antoine Leboeuf
-   Ian Sinclair
-   Grant McCartney
-   Jean-Francois Prieur
-   Piotr Tompalski
:::
:::

## Thank you!

![](images/affiliations.png)
